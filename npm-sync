#!/bin/bash
set -e

# Fonction de nettoyage
cleanup() {
  local exit_code=$?
  rm -f "$CSV" "$DOMAINS" "$ALL_DOMAINS" 2>/dev/null
  unset PIHOLE_PASSWORD SID CSRF AUTH_RESPONSE
  
  if [[ -n "$SID" ]]; then
    curl -sS -X DELETE "${PIHOLE_HOST}/api/auth" \
      -H "X-FTL-SID: ${SID}" > /dev/null 2>&1 || true
  fi
  
  exit $exit_code
}

trap cleanup EXIT INT TERM

# Charge les variables d'environnement
ENV_FILE="/root/.env"
if [[ -f "$ENV_FILE" ]]; then
  export $(grep -v '^#' "$ENV_FILE" | xargs)
else
  echo "‚ùå Fichier $ENV_FILE introuvable"
  exit 1
fi

# Variables
SSH="ssh -i /root/.ssh/id_pihole -o ConnectTimeout=5 root@${NPM_HOST}"
CSV="/tmp/npm_domains.csv"
ALL_DOMAINS="/tmp/all_domains.txt"
DOMAINS="/tmp/npm_domains.txt"

# Valeurs par d√©faut
MIN_DOMAIN_COUNT=${MIN_DOMAIN_COUNT:-3}
CLEANUP_ORPHANS=${CLEANUP_ORPHANS:-false}

# Validation
if [[ -z "$PIHOLE_HOST" || -z "$PIHOLE_PASSWORD" || -z "$NPM_HOST" ]]; then
  echo "‚ùå Variables manquantes dans .env"
  exit 1
fi

# 1. Authentification API Pi-hole
echo "üîê Authentification Pi-hole..."
AUTH_RESPONSE=$(curl -sS -X POST "${PIHOLE_HOST}/api/auth" \
  -H "Content-Type: application/json" \
  -d "{\"password\":\"${PIHOLE_PASSWORD}\"}")

SID=$(echo "$AUTH_RESPONSE" | jq -r '.session.sid')
CSRF=$(echo "$AUTH_RESPONSE" | jq -r '.session.csrf')

if [[ "$SID" == "null" || "$CSRF" == "null" ]]; then
  echo "‚ùå √âchec authentification"
  exit 1
fi

# 2. R√©cup√®re tous les domaines depuis NPM
echo "üì• R√©cup√©ration domaines NPM..."
DOMAINS_RAW=$($SSH "sqlite3 /data/database.sqlite 'SELECT domain_names FROM proxy_host WHERE is_deleted = 0;'")
echo "$DOMAINS_RAW" | jq -r '.[]' 2>/dev/null | sort -u > "$ALL_DOMAINS"

# 3. D√©tecte tous les domaines cibles actuels dans NPM
CURRENT_TARGET_DOMAINS=$(awk -F. -v min="$MIN_DOMAIN_COUNT" '{
  if (NF >= 2) {
    suffix = $(NF-1)"."$NF
    count[suffix]++
  }
}
END {
  for (s in count) {
    if (count[s] >= min) print s
  }
}' "$ALL_DOMAINS")

# 4. R√©cup√®re TOUS les CNAMEs de Pi-hole
echo "üîç R√©cup√©ration de tous les CNAMEs Pi-hole..."
ALL_PIHOLE_CNAMES=$(curl -sS -X GET "${PIHOLE_HOST}/api/config/dns/cnameRecords" \
  -H "X-FTL-SID: ${SID}")

# 5. D√©tecte les domaines cibles orphelins (dans Pi-hole mais plus dans NPM)
PIHOLE_TARGET_DOMAINS=$(echo "$ALL_PIHOLE_CNAMES" | jq -r '(.config.dns.cnameRecords // []) | .[] | split(",")[1]' | sort -u)

ORPHAN_DOMAINS=$(comm -23 <(echo "$PIHOLE_TARGET_DOMAINS") <(echo "$CURRENT_TARGET_DOMAINS"))

# 6. Supprime les CNAMEs des domaines orphelins si activ√©
if [[ "$CLEANUP_ORPHANS" == "true" && -n "$ORPHAN_DOMAINS" ]]; then
  echo ""
  echo "üßπ Nettoyage des domaines orphelins..."
  for ORPHAN_DOMAIN in $ORPHAN_DOMAINS; do
    echo "  üóëÔ∏è  Suppression de tous les CNAMEs vers ${ORPHAN_DOMAIN}..."
    
    # R√©cup√®re tous les CNAMEs pointant vers ce domaine
    ORPHAN_CNAMES=$(echo "$ALL_PIHOLE_CNAMES" | jq -r "(.config.dns.cnameRecords // []) | .[] | select(endswith(\",${ORPHAN_DOMAIN}\"))")
    
    while IFS= read -r cname_entry; do
      [[ -z "$cname_entry" ]] && continue
      
      # Encode pour l'URL
      ENCODED=$(echo "$cname_entry" | sed 's/,/%2C/g')
      
      HTTP_CODE=$(curl -sS -w "%{http_code}" -o /dev/null \
        -X DELETE "${PIHOLE_HOST}/api/config/dns/cnameRecords/${ENCODED}" \
        -H "X-FTL-SID: ${SID}" \
        -H "X-FTL-CSRF: ${CSRF}")
      
      SOURCE_DOMAIN=$(echo "$cname_entry" | cut -d',' -f1)
      if [[ "$HTTP_CODE" == "200" || "$HTTP_CODE" == "204" ]]; then
        echo "    ‚ùå ${SOURCE_DOMAIN}"
      else
        echo "    ‚ö†Ô∏è  √âchec suppression ${SOURCE_DOMAIN} (HTTP ${HTTP_CODE})"
      fi
    done <<< "$ORPHAN_CNAMES"
  done
fi

# V√©rification si des domaines cibles existent
if [[ -z "$CURRENT_TARGET_DOMAINS" ]]; then
  echo "‚ö†Ô∏è  Aucun domaine cible d√©tect√© dans NPM (seuil: ${MIN_DOMAIN_COUNT})"
  echo "‚úÖ Synchronisation termin√©e : 0 supprim√©s, 0 ajout√©s"
  exit 0
fi

echo ""
echo "üéØ Domaines cibles d√©tect√©s: $CURRENT_TARGET_DOMAINS"

# Compteurs globaux
TOTAL_DELETE=0
TOTAL_ADD=0

# Boucle sur chaque domaine cible actuel
for TARGET_DOMAIN in $CURRENT_TARGET_DOMAINS; do
  echo ""
  echo "üìç Traitement de ${TARGET_DOMAIN}..."
  
  # Filtre uniquement les sous-domaines du domaine cible
  grep "\.${TARGET_DOMAIN}$" "$ALL_DOMAINS" > "$DOMAINS" || true
  COUNT=$(wc -l < "$DOMAINS")
  echo "üìä ${COUNT} domaines ${TARGET_DOMAIN} trouv√©s"

  # R√©cup√®re CNAMEs actuels de Pi-hole pour ce domaine
  EXISTING=$(echo "$ALL_PIHOLE_CNAMES" | jq -r "(.config.dns.cnameRecords // []) | .[] | select(endswith(\",${TARGET_DOMAIN}\")) | split(\",\")[0]" | sort)

  # D√©termine les CNAMEs √† supprimer et ajouter
  TO_DELETE=$(comm -23 <(echo "$EXISTING") <(sort "$DOMAINS"))
  TO_ADD=$(comm -13 <(echo "$EXISTING") <(sort "$DOMAINS"))

  DELETE_COUNT=$(echo "$TO_DELETE" | awk 'NF' | wc -l)
  ADD_COUNT=$(echo "$TO_ADD" | awk 'NF' | wc -l)

  echo "üóëÔ∏è  ${DELETE_COUNT} CNAMEs √† supprimer"
  echo "‚ûï ${ADD_COUNT} CNAMEs √† ajouter"

  # Supprime les CNAMEs obsol√®tes
  if [[ -n "$TO_DELETE" ]]; then
    while read domain; do
      [[ -z "$domain" ]] && continue
      ENCODED="${domain}%2C${TARGET_DOMAIN}"
      
      HTTP_CODE=$(curl -sS -w "%{http_code}" -o /dev/null \
        -X DELETE "${PIHOLE_HOST}/api/config/dns/cnameRecords/${ENCODED}" \
        -H "X-FTL-SID: ${SID}" \
        -H "X-FTL-CSRF: ${CSRF}")
      
      if [[ "$HTTP_CODE" == "200" || "$HTTP_CODE" == "204" ]]; then
        echo "  ‚ùå ${domain}"
      else
        echo "  ‚ö†Ô∏è  √âchec suppression ${domain} (HTTP ${HTTP_CODE})"
      fi
    done <<< "$TO_DELETE"
  fi

  # Ajoute les nouveaux CNAMEs
  if [[ -n "$TO_ADD" ]]; then
    while read domain; do
      [[ -z "$domain" ]] && continue
      
      ENCODED="${domain}%2C${TARGET_DOMAIN}"
      RESPONSE=$(curl -sS -w "\n%{http_code}" \
        -X PUT "${PIHOLE_HOST}/api/config/dns/cnameRecords/${ENCODED}" \
        -H "X-FTL-SID: ${SID}" \
        -H "X-FTL-CSRF: ${CSRF}" \
        -H "Content-Type: application/json" \
        -d "{}")
      
      HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
      BODY=$(echo "$RESPONSE" | head -n-1)
      
      if [[ "$HTTP_CODE" == "200" || "$HTTP_CODE" == "201" || "$HTTP_CODE" == "204" ]]; then
        echo "  ‚úÖ ${domain}"
      else
        if echo "$BODY" | grep -q "duplicate CNAME"; then
          echo "  ‚ÑπÔ∏è  ${domain} (d√©j√† existant)"
        else
          echo "  ‚ö†Ô∏è  √âchec ajout ${domain} (HTTP ${HTTP_CODE})"
        fi
      fi
    done <<< "$TO_ADD"
  fi
  
  # Cumule les compteurs
  TOTAL_DELETE=$((TOTAL_DELETE + DELETE_COUNT))
  TOTAL_ADD=$((TOTAL_ADD + ADD_COUNT))
done

# Reload DNS (une seule fois apr√®s tous les domaines)
echo ""
echo "‚ôªÔ∏è  Rechargement DNS..."
curl -sS --http1.1 -X POST "${PIHOLE_HOST}/api/action/restartdns" \
  -H "X-FTL-SID: ${SID}" \
  -H "X-FTL-CSRF: ${CSRF}" > /dev/null 2>&1 || echo "‚ö†Ô∏è  √âchec restart DNS"

echo "‚úÖ Synchronisation termin√©e : ${TOTAL_DELETE} supprim√©s, ${TOTAL_ADD} ajout√©s"
